"use strict";!function(){var e=require("./tdweapp-conf.js"),t={},n=!1,a={deviceInfo:!0,networkInfo:!0,locationInfo:!0,userInfo:!0},i={sdkInfo:{version:"3",minorVersion:"0",build:"0",platform:"Weapp",partner:""},appInfo:{versionCode:e.config.versionCode||"1",versionName:e.config.versionName||"1.0.0",installTime:0,displayName:e.config.appName,appKey:e.config.appkey,uniqueId:e.config.wxAppid,channel:""},deviceInfo:{type:"mobile",softwareConfig:{},hardwareConfig:{},deviceId:""},networksInfo:[{type:"wifi",available:!1,connected:!1},{type:"cellular",available:!1,connected:!1,current:[]},{type:"unknown",available:!1,connected:!1}],locationInfo:{},appContextInfo:{}},o={firstInit:!1,initTime:0,sessionId:"",sessionStartTime:0,appLaunchInfo:null,sendFailTimes:0,Store:{set:function(e,t){return wx.setStorageSync(e,t),!0},get:function(e){return wx.getStorageSync(e)},remove:function(e){return wx.removeStorageSync(e),!0}},random:function(){for(var e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",t=e.length,n="",a=0;a<12;a++)n+=e.charAt(Math.floor(Math.random()*t));return n},timestamp:function(){return(new Date).getTime()},uuid:function(){return"weapp-"+this.timestamp()+"-"+this.random()},addStoreData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t="TDSDK_EVENT_"+o.sessionId,n=o.Store.get(t);n=n&&n.length?n.concat(e):e,o.Store.set(t,n),n.length>=30&&(r.sessionContinue(),r.startLoop())},eventHandle:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e){var n=getCurrentPages(),a=n[n.length-1],i={eventId:e,label:a.__route__,count:1,startTime:o.timestamp()};if("WeappShare"===e){i.shareTickets=t.shareTickets;var s=JSON.parse(JSON.stringify(a.options));s.user=o.deviceId,s.title=t.title,s.desc=t.desc,s.path=t.path,i.params=s}o.addStoreData([i])}},getCacheData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.keys(e),n=[],a=[];return t.length&&t.forEach(function(t){var i=e[t];i&&i.sendFail&&i.data&&(n=n.concat(i.data),a.push(t))}),{data:n,keys:a}},sendCacheList:{},updateSendTime:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return e.forEach(function(n,a){n.action&&n.action.data&&(e[a].action.data.start=t)}),e},getRequestData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=JSON.parse(JSON.stringify(e)),n=o.sendCacheList;if(Object.keys(n).length){var a=o.getCacheData(n);t=t.concat(a.data),a.keys.forEach(function(e){return delete n[e]})}var i=t.length;if(i){var s=[];i>=30?(JSON.stringify(t)>61440&&s.push(t.splice(0,i/2)),s.push(t)):s.push(t),s.forEach(function(e){var t=o.timestamp();n[t]={data:e,sendFail:!1};var a=o.updateSendTime(e,o.timestamp());o.request(t,a)})}},request:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];wx.request({url:"https://h5.udrig.com/app/wx/v1",data:JSON.stringify(t),method:"POST",success:function(t){200===t.statusCode&&(delete o.sendCacheList[e],o.sendFailTimes=0,c.appIsHide||(clearTimeout(r.timeout),r.timeout=null,r.startLoop()))},fail:function(){o.sendCacheList[e].sendFail=!0,o.sendFailTimes<5&&o.sendFailTimes++}})}},s={sendTime:0,statusType:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=[],a=JSON.parse(JSON.stringify(t)),i={domain:e.domain,name:e.name,data:e.data};a.ts=e.data.start||o.timestamp(),a.action=i,n.push(a),o.getRequestData(n)},dataType:function(e,t){var n=this.getStoreList(e,t);o.getRequestData(n)},getEventType:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e.pageEvent)return{domain:"page",name:"leave"};if(e.eventId){var t=e.eventId,n={};switch(t){case"WeappShare":n={domain:"user",name:"share"};break;case"WeappPullDownRefresh":n={domain:"page",name:"pullDownRefresh"};break;case"WeappReachBottom":n={domain:"page",name:"reachBottom"};break;default:n={domain:"appEvent",name:""}}return n}},getStoreList:function(e,n){var a=this,i=[],s=e||o.sessionId,r=JSON.stringify(t),c=o.Store.get("TDSDK_EVENT_"+s);return c&&c.length&&(c.forEach(function(e){var t=a.getEventType(e),s=JSON.parse(r);n&&s.appContext&&(s.appContext.sessionStartTime=n);var c=JSON.parse(JSON.stringify(e));c.pageEvent&&delete c.pageEvent,c.status=2;var u={domain:t.domain,name:t.name,data:c};s.ts=c.startTime?c.startTime:o.timestamp(),s.action=u,i.push(s)}),o.Store.remove("TDSDK_EVENT_"+s)),i}},r={timeout:null,init:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o.appLaunchInfo=t,r.judgeRequireData(),r.getLocalParams(),r.getSystemInfo(),r.getNetwork(),e.config.getLocation&&r.getLocation(),e.config.getUserInfo&&r.getUserInfo()},launchRequest:function(){var e={first:!0};s.statusType({domain:"app",name:"init",data:e})},sessionStart:function(e){var t=o.appLaunchInfo||{},n={status:1,duration:0,name:t.path,scene:t.scene,query:t.query||{},shareTicket:t.shareTicket};e&&r.setNewSession(),n.start=o.Store.get("TDSDK_session_time")||o.timestamp(),n.url=r.getUrl(n.name,n.query),s.statusType({domain:"session",name:"begin",data:n})},getUrl:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=Object.keys(t),a=n.sort(function(e,t){return e>t})||[],i=a.length?e+"?":e;return a.forEach(function(e,n){0!==n&&(i+="&"),i+=e+"="+t[e]}),i},sessionContinue:function(){s.dataType()},sessionEnd:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t={status:3,start:e.startTime,duration:e.duration};s.statusType({domain:"session",name:"end",data:t})},sendTmpSession:function(){r.sessionContinue(),r.startLoop()},startLoop:function(){r.timeout&&(clearTimeout(r.timeout),r.timeout=null);var e=3e3*(o.sendFailTimes+1);r.timeout=setTimeout(function(){r.sendTmpSession()},e)},judgeRequireData:function(){i.appInfo.appKey||(i.appInfo.appKey="",console.error("请填写您在TalkingData申请的App ID")),i.appInfo.displayName||(i.appInfo.displayName="appname",console.error("请填写您的小程序名称"))},getLocalParams:function(){var e=o.Store.get("TDSDK_initTime");e?o.initTime=e:(o.initTime=o.timestamp(),o.Store.set("TDSDK_initTime",o.initTime),o.firstInit=!0),i.appInfo.installTime=o.initTime;var t=o.Store.get("TDSDK_deviceId");t||(t=o.uuid(),o.Store.set("TDSDK_deviceId",t)),i.deviceInfo.deviceId={tid:t};var n=o.appLaunchInfo.query||{},a=n.TDChannelId?n.TDChannelId:"";i.appInfo.channel=a,r.setNewSession()},setNewSession:function(){o.sessionId=o.uuid(),o.sessionStartTime=o.timestamp(),o.Store.set("TDSDK_session_time",o.sessionStartTime),i.appContextInfo.sessionId=o.sessionId,i.appContextInfo.sessionStartTime=o.sessionStartTime},getLaunchInfo:function(){var e=JSON.parse(JSON.stringify(r.launchOptions));return e.type="appLaunch",e},getAppProfile:function(){if(!n){var o=["deviceInfo","networkInfo"],s=!0;e.config.getUserInfo&&o.push("userInfo"),e.config.getLocation&&o.push("locationInfo"),o.forEach(function(e){a[e]&&(s=!1)}),s&&(t.device=i.deviceInfo,t.sdk=i.sdkInfo,t.networks=i.networksInfo,t.locations=[i.locationInfo],t.appContext=i.appContextInfo,t.user=i.userInfo,t.app=i.appInfo,n=!0,this.startRequest())}},startRequest:function(){o.firstInit&&r.launchRequest(),this.sessionStart(),this.startLoop()},getLocation:function(){wx.getLocation({type:"wgs84",complete:function(e){if(e.longitude||e.latitude||e.horizontalAccuracy||e.verticalAccuracy){var t=i.locationInfo;t.lng=e.longitude,t.lat=e.latitude,t.hAccuracy=e.horizontalAccuracy,t.vAccuracy=e.verticalAccuracy,t.speed=e.speed,t.altitude=e.altitude,t.ts=(new Date).getTime()}a.locationInfo=!1,r.getAppProfile()}})},getNetwork:function(){wx.getNetworkType({complete:function(e){var t=i.networksInfo,n=e.networkType;"wifi"===n?(t[0].available=!0,t[0].connected=!0):"unknown"===n?(t[2].available=!0,t[2].connected=!0):"none"!==n&&(t[1].available=!0,t[1].connected=!0,t[1].current.push({type:n})),a.networkInfo=!1,r.getAppProfile()}})},getSystemInfo:function(){wx.getSystemInfo({complete:function(e){if(e.model||e.system||e.SDKVersion){var t={model:e.model,pixel:e.screenWidth+"*"+e.screenHeight+"*"+e.pixelRatio,densityDpi:e.pixelRatio,brand:e.brand},n={os:e.system,local:e.language,osVersionCode:e.version,timezone:-(new Date).getTimezoneOffset()/60,mpVersion:e.SDKVersion};i.deviceInfo.hardwareConfig=t,i.deviceInfo.softwareConfig=n}a.deviceInfo=!1,r.getAppProfile()}})},getUserInfo:function(){wx.getUserInfo({complete:function(e){if(e.userInfo){var t={name:e.userInfo.nickName,gender:e.userInfo.gender};i.deviceInfo.softwareConfig.language=e.userInfo.language,i.appContextInfo.account=t}a.userInfo=!1,r.getAppProfile()}})}},c={isHide2Show:!1,appIsHide:!1,show:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(c.appIsHide=!1,c.getlastTmpData(),c.isHide2Show){var t=o.Store.get("TDSDK_TMP_time_end_"+o.sessionId);e.scene!==o.appLaunchInfo.scene?(o.appLaunchInfo=e,c.sessionRestart(t)):o.timestamp()-t>3e4?c.sessionRestart(t):o.Store.remove("TDSDK_TMP_time_end_"+o.sessionId),c.isHide2Show=!1,r.startLoop()}},sessionRestart:function(e){var t=o.Store.get("TDSDK_TMP_time_start_"+o.sessionId),n={startTime:t,duration:parseInt((e-t)/1e3)};r.sessionEnd(n),o.Store.remove("TDSDK_TMP_time_start_"+o.sessionId),o.Store.remove("TDSDK_TMP_time_end_"+o.sessionId),o.Store.remove("TDSDK_session_time"),r.sessionStart(!0)},hide:function(){c.appIsHide=!0,clearTimeout(r.timeout),r.timeout=null,r.sessionContinue(),c.isHide2Show=!0,o.Store.set("TDSDK_TMP_time_start_"+o.sessionId,o.Store.get("TDSDK_session_time")),o.Store.set("TDSDK_TMP_time_end_"+o.sessionId,o.timestamp())},getlastTmpData:function(){var e=[],t=wx.getStorageInfoSync().keys||[];t&&t.length&&(t=t.filter(function(e){return e.indexOf("TDSDK_EVENT")>-1})),t&&t.length&&t.forEach(function(t){var n={};t.split("_")[2],n.id=t.split("_")[2],n.time=n.id.split("-")[1],e.push(n)}),c.sendLastTmpData(e)},sendLastTmpData:function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach(function(e){s.dataType(e.id,e.time)})}},u={curPagePath:"",refer:"",pageTime:0,pageQuery:{},show:function(){""!==u.curPagePath&&(u.refer=u.curPagePath),u.pageTime=o.timestamp()},hide:function(){var e=[{name:u.curPagePath,from:u.refer||"",query:u.pageQuery,scene:o.appLaunchInfo.scene,duration:parseInt((o.timestamp()-u.pageTime)/1e3),startTime:u.pageTime,pageEvent:!0}];o.addStoreData(e)}};r.init(wx.getLaunchOptionsSync()),u.show(),wx.onShow(function(){c.show(),u.show()}),wx.onHide(function(){c.hide(),u.hide()})}();