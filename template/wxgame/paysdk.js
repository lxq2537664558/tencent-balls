"use strict";function pay(r,e){var o=r.env,t=r.offerId,n=r.gameid,a=r.productId,u=r.productCount||1,s=r.token,d=Number(r.test),i=r.userdata;if(isNaN(d)&&(d=0),void 0===o)return e(-1,"缺少参数env");if(void 0===t)return e(-1,"缺少参数offerId");if(void 0===n)return e(-1,"缺少参数gameid");if(void 0===a)return e(-1,"缺少参数productId");if(void 0===s)return e(-1,"缺少参数token");var c=Date.now(),f=PAY_SERVER_URL;d&&(f=PAY_TEST_SERVER_URL);var l=f+"/wxagame2/order.php?gameid="+n+"&token="+s+"&product_id="+a+"&product_count="+u+"&now="+c;i&&(l+="&userdata="+i),console.log("请求下单url",l),wx.request({url:l,success:function(r){var n=r.data,u=(r.header,r.statusCode);r.errMsg;if(console.log("请求下单",n,u),200!=u)return e(-1,"支付服务器异常"+u);if(n.error)return e(n.error,n.errmsg);var d=Number(n.trans_id),i=Number(n.buy_quantity);wx.requestMidasPayment({mode:"game",env:o,offerId:t,currencyType:"USD",platform:"android",buyQuantity:i,zoneId:a,success:function(){console.log("充值游戏币成功");var r=Date.now(),o=f+"/wxagame2/buy.php?trans_id="+d+"&token="+s+"&now="+r;console.log("请求兑换游戏币url",o),wx.request({url:o,success:function(r){var o=r.data,t=r.statusCode;r.header,r.errMsg;return 200!=t?e(-1,"支付服务器异常"+t):o.error?e(o.error,o.errmsg):(console.log("兑换游戏币成功"),e(0,"支付成功",d))},fail:function(r){return console.log("fail",r),e(-1,"请求支付服务器失败，你的订单将延迟到账，请稍等")}})},fail:function(r){var o=r.errCode,t=r.errMsg;return t.indexOf("用户取消购买")>=0?e(-1,"用户取消购买"):e(-1,"扣款失败"+o+t)}})},fail:function(r){return console.log("fail",r),e(-1,"连接支付服务器失败")}})}var PAY_SERVER_URL="https://login.kxtoo.com/pay",PAY_TEST_SERVER_URL="http://115.159.53.187/pay_test";module.exports={pay:pay};