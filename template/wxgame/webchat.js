"use strict";var chat={};module.exports=chat,chat.loginws="",chat.socket=null,chat.status=0,chat.token="",chat.gameId="",chat.chatId=null,chat.chatRoomId=0,chat.onConnect=null,chat.onMessage=null,chat.onDisconnect=null,chat.onError=null,chat.callbackList=[],chat.MSGOBJ_PLAYER=1,chat.MSGOBJ_ROOM=2,chat.MSGTYPE_TEXT=1,chat.STATUS_DISCONNECTED=0,chat.STATUS_CONNECTING=1,chat.STATUS_CONNECTED=2,chat.init=function(t){chat.loginws?t():(chat.loginws="wss://chat.kxtoo.com/",t(),chat.alive())},chat.close=function(){chat.status==chat.STATUS_CONNECTED&&chat.socket&&chat.socket.close()},chat.connect=function(t,a){chat.init(function(){chat.token=t,chat.gameId=a,"https:"==location.protocol&&0!=chat.loginws.indexOf("wss:")||(chat.socket=wx.connectSocket({url:chat.loginws}),chat.socket.onOpen(function(c){var s=JSON.stringify({_C:"player",cmd:"login",data:{token:t,gameId:a},_T:0});chat.socket.send({data:s})}),chat.socket.onError(function(t){chat.onError&&chat.onError(t)}),chat.socket.onClose(function(t){chat.status=chat.STATUS_DISCONNECTED,chat.onDisconnect()}),chat.socket.onMessage(function(t){if("string"==typeof t.data){var a=JSON.parse(t.data);switch(a.cmd){case"login":a.error?chat.onError&&chat.onError(a.error):(chat.callbackList=[],chat.callbackList.sendMsg=[],chat.chatId=a.data.chatId,chat.onConnect&&chat.onConnect(),chat.status=chat.STATUS_CONNECTED);break;case"sendMsg":if(1==a._T){var c=chat.callbackList.sendMsg.pop();c&&c(a.error)}else if(2==a._T&&(chat.onMessage&&chat.onMessage(a.data),a.data.msg_type==chat.MSGOBJ_ROOM)){var s=wx.getStorageSync(chat.gameId+"_"+chat.chatRoomId+"_time")||0;a.data.time>s&&wx.setStorageSync(chat.gameId+"_"+chat.chatRoomId+"_time",a.data.time)}break;case"joinChatRoom":chat.callbackList.joinChatRoom&&chat.callbackList.joinChatRoom(a.error,a.data),a.data&&(chat.chatRoomId=a.data.chatRoomId);break;case"exitChatRoom":chat.callbackList.exitChatRoom&&chat.callbackList.exitChatRoom(a.error,a.data);break;case"getSessionList":chat.callbackList.getSessionList&&chat.callbackList.getSessionList(a.error,a.data);break;case"getSessionListDetail":chat.callbackList.getSessionListDetail&&chat.callbackList.getSessionListDetail(a.error,a.data);break;case"getSessionListLastMsg":chat.callbackList.getSessionListLastMsg&&chat.callbackList.getSessionListLastMsg(a.error,a.data);break;case"getSessionHistory":chat.callbackList.getSessionHistory&&chat.callbackList.getSessionHistory(a.error,a.data);break;case"sendLastMsg":if(a.data){var s=wx.getStorageSync(chat.gameId+"_"+chat.chatRoomId+"_time")||0;for(var e in a.data.msgList)chat.onMessage&&chat.onMessage(a.data.msgList[e]),a.data.msgList[e].time>s&&(s=a.data.msgList[e].time);wx.setStorageSync(chat.gameId+"_"+chat.chatRoomId+"_time",s)}}}}))})},chat.sendMessage=function(t,a,c,s){if(a){chat.callbackList.sendMsg.push(s);var e=JSON.stringify({_C:"player",cmd:"sendMsg",data:{to_id:t,msg_type:chat.MSGOBJ_PLAYER,msg_content_type:chat.MSGTYPE_TEXT,msg_data:a,ext:c},_T:0});chat.socket.send({data:e})}},chat.sendRoomMessage=function(t,a,c,s){if(a){chat.callbackList.sendMsg.push(s);var e=JSON.stringify({_C:"player",cmd:"sendMsg",data:{to_id:t,msg_type:chat.MSGOBJ_ROOM,msg_content_type:chat.MSGTYPE_TEXT,msg_data:a,ext:c},_T:0});chat.socket.send({data:e})}},chat.joinChatRoom=function(t,a){chat.chatRoomId||wx.removeStorageSync(chat.gameId+"_"+t+"_time"),chat.callbackList.joinChatRoom=a;var c=wx.getStorageSync(chat.gameId+"_"+t+"_time")||0,s=JSON.stringify({_C:"player",cmd:"joinChatRoom",data:{chatRoomId:t,time:c},_T:0});chat.socket.send({data:s})},chat.exitChatRoom=function(t,a){chat.chatRoomId||wx.removeStorageSync(chat.gameId+"_"+t+"_time"),chat.callbackList.exitChatRoom=a;var c=wx.getStorageSync(chat.gameId+"_"+t+"_time")||0,s=JSON.stringify({_C:"player",cmd:"exitChatRoom",data:{chatRoomId:t,time:c},_T:0});chat.socket.send({data:s})},chat.getSessionList=function(t){chat.callbackList.getSessionList=t;var a=JSON.stringify({_C:"player",cmd:"getSessionList",data:{},_T:0});chat.socket.send({data:a})},chat.getSessionListDetail=function(t){chat.callbackList.getSessionListDetail=t;var a=JSON.stringify({_C:"player",cmd:"getSessionListDetail",data:{},_T:0});chat.socket.send({data:a})},chat.getSessionListLastMsg=function(t){chat.callbackList.getSessionListLastMsg=t;var a=JSON.stringify({_C:"player",cmd:"getSessionListLastMsg",data:{},_T:0});chat.socket.send({data:a})},chat.removeSession=function(t){var a=JSON.stringify({_C:"player",cmd:"removeSession",data:{session:t},_T:0});chat.socket.send({data:a})},chat.getSessionHistory=function(t,a){chat.callbackList.getSessionHistory=a;var c=JSON.stringify({_C:"player",cmd:"getSessionHistory",data:{session:t},_T:0});chat.socket.send({data:c})},chat.getStatus=function(){return chat.status},chat.alive=function(){setTimeout(function(){if(chat.status==chat.STATUS_CONNECTED){var t=JSON.stringify({_C:"player",cmd:"alive",data:{},_T:0});chat.socket.send({data:t})}chat.alive()},1e4)};