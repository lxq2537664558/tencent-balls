"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function loadText(e,n,r){var t=new XMLHttpRequest;t.onload=function(){null!=n&&n(t.responseText)},t.onerror=function(n){if(null!=r){var t=new RES.ResourceManagerError(1001,e);r(t)}},t.open("get",e),t.send()}function createInnerAudioContext(){var e=wx.createInnerAudioContext();return e.__setSrc=function(n){var r=wx.env.USER_DATA_PATH+"/"+cache.cacheDir+"/"+n;r=r.replace("http://","").replace("https://",""),cache.exists(r)?e.src=r:cache.download(n,r,function(){e.src=r},function(r){e.src=n})},e}function loadImage(e,n,r){var t=wx.createImage();t.onload=function(){var e=new egret.Texture,r=new egret.BitmapData(t);e._setBitmapData(r),setTimeout(function(){null!=n&&n(e)},0)},t.onerror=function(){if(null!=r){var n=new RES.ResourceManagerError(1001,e);r(n)}},t.src=e}var _createClass=function(){function e(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,r,t){return r&&e(n.prototype,r),t&&e(n,t),n}}(),fs=wx.getFileSystemManager(),cache=require("./cache"),TextProcessor=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"onLoadStart",value:function(e,n){return new Promise(function(e,r){var t=n.url,o=wx.env.USER_DATA_PATH+"/"+cache.cacheDir+"/"+n.url;if(t.indexOf("://")<0&&(t=n.root+n.url),o=o.replace("http://","").replace("https://",""),cache.exists(o)){var c=fs.readFileSync(o,"utf-8");e(c)}else cache.download(t,o,function(){var n=fs.readFileSync(o,"utf-8");e(n)},function(n){loadText(t,function(n){e(n)},function(e){r(e)})})})}},{key:"onRemoveStart",value:function(e,n){return Promise.resolve()}}]),e}(),processor=new TextProcessor;RES.processor.map("text",processor),window.platform.createInnerAudioContext=createInnerAudioContext;var ImageProcessor=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"onLoadStart",value:function(e,n){return new Promise(function(e,r){var t=n.url,o=wx.env.USER_DATA_PATH+"/"+cache.cacheDir+"/"+n.url;t.indexOf("://")<0&&(t=n.root+n.url),o=o.replace("http://","").replace("https://",""),cache.exists(o)?loadImage(o,function(n){e(n)},function(e){r(e)}):cache.download(t,o,function(){loadImage(o,function(n){e(n)},function(e){r(e)})},function(n){loadImage(t,function(n){e(n)},function(e){r(e)})})})}},{key:"onRemoveStart",value:function(e,n){return e.get(n).dispose(),Promise.resolve()}}]),e}(),processor=new ImageProcessor;RES.processor.map("image",processor);